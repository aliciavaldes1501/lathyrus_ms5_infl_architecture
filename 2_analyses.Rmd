---
title: "Effects of inflorescence architecture on within-individual variation in phenology and reproductive success of flowers in Lathyrus vernus"
subtitle: "First analyses"
author : "Alicia Vald√©s"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document:
    toc: yes
    toc_depth: 4
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
options(tibble.width = Inf)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

```{r load packages, include=FALSE}
library(tidyverse)
library(readxl)
library(lubridate)
library(moments)
library(RColorBrewer)
library(ggthemes)
library(ggridges)
library(brms)
library(ggeffects)
library(glmmTMB)
library(sjPlot)
library(gridExtra)
library(lme4)
library(lmerTest)
library(performance)
library(partR2)
library(DHARMa)
library(car)
library(piecewiseSEM)
library(semEff)
library(DiagrammeR)
library(DiagrammeRsvg)
library(lavaanPlot)
library(magrittr)
library(rsvg)
library(viridis)
library(cowplot)
library(bayesplot)
```

```{r Define ggplot themes and palettes, include=FALSE}
my_theme <- function(){
  theme_base()+theme(plot.background=element_rect(fill="white", colour=NA))+
  theme(legend.position="none")+theme(text=element_text(family="serif"))+
  theme(plot.title = element_text(hjust =-0.06))
}
my_theme_legend <- function(){
  theme_base()+theme(plot.background=element_rect(fill="white", colour=NA))+
  theme(text=element_text(family="serif"))+
  theme(plot.title = element_text(hjust =-0.06))
}
myPalette <- colorRampPalette(brewer.pal(11, "YlOrRd"))
```

Load previously created objects>

```{r}
load("output/models/mod_within_among_87.rda")
load("output/models/mod_within_among_88.rda")
load("output/models/mod_within_among_89.rda")
load("output/models/mod_within_among_frset_87.rda")
load("output/models/mod_within_among_frset_88.rda")
load("output/models/mod_within_among_frset_89.rda")
load("output/models/mod_within_among_seedset_87.rda")
load("output/models/mod_within_among_seedset_88.rda")
load("output/models/mod_within_among_seedset_89.rda")
```

# Read data for individual flowers

```{r}
data_id_flowers <- read_csv("data/clean/data_id_flowers.csv")%>%
  mutate(year=as.factor(year))
```

# Data preparation

Calculate total n flowers in plant (tot_fls_in_plant), total fruit initiation (tot_fr_init_in_plant) (n initiated fr / n fl), seed predation at the plant level (seed_predation_plant) range and variance in opening date

```{r}
data_id_flowers<-left_join(data_id_flowers,
                           data_id_flowers%>%
                             group_by(year,id)%>%
                             summarise(tot_fls_in_plant=n(), 
                                       tot_fr_init_in_plant=
                                         sum(initiated_fr)/tot_fls_in_plant,
                                       seed_predation_plant=sum(n_pred_seeds,
                                                                na.rm=T)/
                                         sum(n_seeds,na.rm=T),
                                       range_opening_date=max(opening_date_v)-
                                         min(opening_date_v),
                                       var_opening_date=var(opening_date_v)))
```

# Figure 1: Lathyrus vernus architechture (Inkscape)

# Q1: Components of variation

## Opening date

How much variation in opening date of individual flowers can be attributed to among-individual variation among plants within the population, and to within-individual variation among flowers on the same plants? 

How much of the within-individual variation can be attributed to variation among shoots within an individual, among racemes within a shoot, and among flowers within a raceme?

Check distribution of opening dates:

```{r}
hist(data_id_flowers$opening_date_v)
```

Looks quite normal.

Variance partitioning:

```{r eval=FALSE, include=FALSE}
mod_within_among_87<-brm(opening_date_v~1+(1|id/shoot_id/raceme_id),
                         data=subset(data_id_flowers,year==1987),
                         family=gaussian(),
                         chains=4,cores=4,iter=10000,warmup=3000,thin=5,
                         control=list(max_treedepth=11,adapt_delta = 0.99))
# Residual variance is for flower_id
save(mod_within_among_87, file = "output/models/mod_within_among_87.rda")
```

```{r eval=FALSE, include=FALSE}
mod_within_among_88<-brm(opening_date_v~1+(1|id/shoot_id/raceme_id),
                         data=subset(data_id_flowers,year==1988),
                         family=gaussian(),
                         chains=4,cores=4,iter=10000,warmup=3000,thin=5,
                         control=list(max_treedepth=12,adapt_delta = 0.99))
# Residual variance is for flower_id
save(mod_within_among_88, file = "output/models/mod_within_among_88.rda")
```

```{r eval=FALSE, include=FALSE}
mod_within_among_89<-brm(opening_date_v~1+(1|id/shoot_id/raceme_id),
                         data=subset(data_id_flowers,year==1989),
                         family=gaussian(),
                         chains=4,cores=4,iter=10000,warmup=3000,thin=5,
                         control=list(max_treedepth=12,adapt_delta = 0.99))
# Residual variance is for flower_id
save(mod_within_among_89, file = "output/models/mod_within_among_89.rda")
```

```{r}
v_id_87 <- (VarCorr(mod_within_among_87, summary=FALSE)$id$sd)^2
v_shoot_87 <- (VarCorr(mod_within_among_87, summary=FALSE)$`id:shoot_id`$sd)^2
v_raceme_87 <- (VarCorr(mod_within_among_87,
                        summary=FALSE)$`id:shoot_id:raceme_id`$sd)^2
v_flower_87 <- (VarCorr(mod_within_among_87, summary=FALSE)$residual$sd)^2
prop_v_id_87 <- as.mcmc(v_id_87 / 
                          (v_id_87 + v_shoot_87 + v_raceme_87 + v_flower_87))
prop_v_shoot_87 <- as.mcmc(v_shoot_87 / 
                             (v_id_87 + v_shoot_87 + v_raceme_87 + v_flower_87))
prop_v_raceme_87 <- as.mcmc(v_raceme_87 / 
                              (v_id_87 + v_shoot_87 + v_raceme_87 + v_flower_87))
prop_v_flower_87 <- as.mcmc(v_flower_87 / 
                              (v_id_87 + v_shoot_87 + v_raceme_87 + v_flower_87))
summary(prop_v_id_87)
summary(prop_v_shoot_87)
summary(prop_v_raceme_87)
summary(prop_v_flower_87)
plot(prop_v_id_87)
plot(prop_v_shoot_87)
plot(prop_v_raceme_87)
plot(prop_v_flower_87)
```

```{r}
v_id_88 <- (VarCorr(mod_within_among_88, summary=FALSE)$id$sd)^2
v_shoot_88 <- (VarCorr(mod_within_among_88, summary=FALSE)$`id:shoot_id`$sd)^2
v_raceme_88 <- (VarCorr(mod_within_among_88,
                        summary=FALSE)$`id:shoot_id:raceme_id`$sd)^2
v_flower_88 <- (VarCorr(mod_within_among_88, summary=FALSE)$residual$sd)^2
prop_v_id_88 <- as.mcmc(v_id_88 / 
                          (v_id_88 + v_shoot_88 + v_raceme_88 + v_flower_88))
prop_v_shoot_88 <- as.mcmc(v_shoot_88 / 
                             (v_id_88 + v_shoot_88 + v_raceme_88 + v_flower_88))
prop_v_raceme_88 <- as.mcmc(v_raceme_88 / 
                              (v_id_88 + v_shoot_88 + v_raceme_88 + v_flower_88))
prop_v_flower_88 <- as.mcmc(v_flower_88 / 
                              (v_id_88 + v_shoot_88 + v_raceme_88 + v_flower_88))
summary(prop_v_id_88)
summary(prop_v_shoot_88)
summary(prop_v_raceme_88)
summary(prop_v_flower_88)
plot(prop_v_id_88)
plot(prop_v_shoot_88)
plot(prop_v_raceme_88)
plot(prop_v_flower_88)
```

```{r}
v_id_89 <- (VarCorr(mod_within_among_89, summary=FALSE)$id$sd)^2
v_shoot_89 <- (VarCorr(mod_within_among_89, summary=FALSE)$`id:shoot_id`$sd)^2
v_raceme_89 <- (VarCorr(mod_within_among_89,
                        summary=FALSE)$`id:shoot_id:raceme_id`$sd)^2
v_flower_89 <- (VarCorr(mod_within_among_89, summary=FALSE)$residual$sd)^2
prop_v_id_89 <- as.mcmc(v_id_89 / 
                          (v_id_89 + v_shoot_89 + v_raceme_89 + v_flower_89))
prop_v_shoot_89 <- as.mcmc(v_shoot_89 / 
                             (v_id_89 + v_shoot_89 + v_raceme_89 + v_flower_89))
prop_v_raceme_89 <- as.mcmc(v_raceme_89 / 
                              (v_id_89 + v_shoot_89 + v_raceme_89 + v_flower_89))
prop_v_flower_89 <- as.mcmc(v_flower_89 / 
                              (v_id_89 + v_shoot_89 + v_raceme_89 + v_flower_89))
summary(prop_v_id_89)
summary(prop_v_shoot_89)
summary(prop_v_raceme_89)
summary(prop_v_flower_89)
plot(prop_v_id_89)
plot(prop_v_shoot_89)
plot(prop_v_raceme_89)
plot(prop_v_flower_89)
```

```{r}
data_props_87<-full_join(
  cbind(data.frame(id_mean=summary(prop_v_id_87)$statistics[1]),
        data.frame(shoot_mean=summary(prop_v_shoot_87)$statistics[1]),
        data.frame(raceme_mean=summary(prop_v_raceme_87)$statistics[1]),
        data.frame(flower_mean=summary(prop_v_flower_87)$statistics[1]))%>%
    pivot_longer(cols=c("id_mean","shoot_mean","raceme_mean","flower_mean"),
                 names_to="effect",values_to="mean",names_pattern="(.*)_mean"),
  cbind(data.frame(id_lower=coda::HPDinterval(prop_v_id_87)[1],
                   id_upper=coda::HPDinterval(prop_v_id_87)[2]),
        data.frame(shoot_lower=coda::HPDinterval(prop_v_shoot_87)[1],
                   shoot_upper=coda::HPDinterval(prop_v_shoot_87)[2]),
        data.frame(raceme_lower=coda::HPDinterval(prop_v_raceme_87)[1],
                   raceme_upper=coda::HPDinterval(prop_v_raceme_87)[2]),
        data.frame(flower_lower=coda::HPDinterval(prop_v_flower_87)[1],
                   flower_upper=coda::HPDinterval(prop_v_flower_87)[2]))%>%
    pivot_longer(cols=c("id_lower","id_upper",
                        "shoot_lower","shoot_upper",
                        "raceme_lower","raceme_upper",
                        "flower_lower","flower_upper"),
                 names_to=c("effect","cat"),names_sep="_",values_to="value")%>%
    pivot_wider(names_from="cat",values_from="value"))%>%
  mutate(year=1987)
data_props_88<-full_join(
  cbind(data.frame(id_mean=summary(prop_v_id_88)$statistics[1]),
        data.frame(shoot_mean=summary(prop_v_shoot_88)$statistics[1]),
        data.frame(raceme_mean=summary(prop_v_raceme_88)$statistics[1]),
        data.frame(flower_mean=summary(prop_v_flower_88)$statistics[1]))%>%
    pivot_longer(cols=c("id_mean","shoot_mean","raceme_mean","flower_mean"),
                 names_to="effect",values_to="mean",names_pattern="(.*)_mean"),
  cbind(data.frame(id_lower=coda::HPDinterval(prop_v_id_88)[1],
                   id_upper=coda::HPDinterval(prop_v_id_88)[2]),
        data.frame(shoot_lower=coda::HPDinterval(prop_v_shoot_88)[1],
                   shoot_upper=coda::HPDinterval(prop_v_shoot_88)[2]),
        data.frame(raceme_lower=coda::HPDinterval(prop_v_raceme_88)[1],
                   raceme_upper=coda::HPDinterval(prop_v_raceme_88)[2]),
        data.frame(flower_lower=coda::HPDinterval(prop_v_flower_88)[1],
                   flower_upper=coda::HPDinterval(prop_v_flower_88)[2]))%>%
    pivot_longer(cols=c("id_lower","id_upper",
                        "shoot_lower","shoot_upper",
                        "raceme_lower","raceme_upper",
                        "flower_lower","flower_upper"),
                 names_to=c("effect","cat"),names_sep="_",values_to="value")%>%
    pivot_wider(names_from="cat",values_from="value"))%>%
  mutate(year=1988)
data_props_89<-full_join(
  cbind(data.frame(id_mean=summary(prop_v_id_89)$statistics[1]),
        data.frame(shoot_mean=summary(prop_v_shoot_89)$statistics[1]),
        data.frame(raceme_mean=summary(prop_v_raceme_89)$statistics[1]),
        data.frame(flower_mean=summary(prop_v_flower_89)$statistics[1]))%>%
    pivot_longer(cols=c("id_mean","shoot_mean","raceme_mean","flower_mean"),
                 names_to="effect",values_to="mean",names_pattern="(.*)_mean"),
  cbind(data.frame(id_lower=coda::HPDinterval(prop_v_id_89)[1],
                   id_upper=coda::HPDinterval(prop_v_id_89)[2]),
        data.frame(shoot_lower=coda::HPDinterval(prop_v_shoot_89)[1],
                   shoot_upper=coda::HPDinterval(prop_v_shoot_89)[2]),
        data.frame(raceme_lower=coda::HPDinterval(prop_v_raceme_89)[1],
                   raceme_upper=coda::HPDinterval(prop_v_raceme_89)[2]),
        data.frame(flower_lower=coda::HPDinterval(prop_v_flower_89)[1],
                   flower_upper=coda::HPDinterval(prop_v_flower_89)[2]))%>%
    pivot_longer(cols=c("id_lower","id_upper",
                        "shoot_lower","shoot_upper",
                        "raceme_lower","raceme_upper",
                        "flower_lower","flower_upper"),
                 names_to=c("effect","cat"),names_sep="_",values_to="value")%>%
    pivot_wider(names_from="cat",values_from="value"))%>%
  mutate(year=1989)
data_props<-rbind(data_props_87,data_props_88,data_props_89)%>%
  mutate(year=factor(year),
         effect=factor(effect,levels=c("id","shoot","raceme","flower")))
```

## Fruit set

How much variation in reproductive success of individual flowers can be attributed to among-individual variation among plants within the population, and to within-individual variation among flowers on the same plants? 

How much of the within-individual variation can be attributed to variation among shoots within an individual, among racemes within a shoot, and among flowers within a raceme?

Variance partitioning:

```{r eval=FALSE, include=FALSE}
mod_within_among_frset_87<-brm(fruit_set~1+(1|id/shoot_id/raceme_id),
                               data=subset(data_id_flowers,year==1987),
                               family=bernoulli(),
                               chains=4,cores=4,iter=10000,warmup=3000,thin=5)
# Residual variance is for flower_id
save(mod_within_among_frset_87, 
     file = "output/models/mod_within_among_frset_87.rda")
```

```{r eval=FALSE, include=FALSE}
mod_within_among_frset_88<-brm(fruit_set~1+(1|id/shoot_id/raceme_id),
                               data=subset(data_id_flowers,year==1988),
                               family=bernoulli(),
                               chains=4,cores=4,iter=10000,warmup=3000,thin=5,
                               control=list(adapt_delta = 0.99))
# Residual variance is for flower_id
save(mod_within_among_frset_88, 
     file = "output/models/mod_within_among_frset_88.rda")
```

```{r eval=FALSE, include=FALSE}
mod_within_among_frset_89<-brm(fruit_set~1+(1|id/shoot_id/raceme_id),
                               data=subset(data_id_flowers,year==1989),
                               family=bernoulli(),
                               chains=4,cores=4,iter=10000,warmup=3000,thin=5,
                               control=list(adapt_delta = 0.99))
# Residual variance is for flower_id
save(mod_within_among_frset_89, 
     file = "output/models/mod_within_among_frset_89.rda")
```

```{r}
v_id_87_frset <- (VarCorr(mod_within_among_frset_87, summary=FALSE)$id$sd)^2
v_shoot_87_frset <- (VarCorr(mod_within_among_frset_87,
                             summary=FALSE)$`id:shoot_id`$sd)^2
v_raceme_87_frset <- (VarCorr(mod_within_among_frset_87,
                              summary=FALSE)$`id:shoot_id:raceme_id`$sd)^2
v_flower_87_frset <- (VarCorr(mod_within_among_frset_87,
                              summary=FALSE)$residual$sd)^2 
# No residual variance! OK?
prop_v_id_87_frset <- as.mcmc(v_id_87_frset /
                                (v_id_87_frset + v_shoot_87_frset +
                                   v_raceme_87_frset))
prop_v_shoot_87_frset <- as.mcmc(v_shoot_87_frset / 
                                   (v_id_87_frset + v_shoot_87_frset +
                                      v_raceme_87_frset))
prop_v_raceme_87_frset <- as.mcmc(v_raceme_87_frset / 
                                    (v_id_87_frset + v_shoot_87_frset +
                                       v_raceme_87_frset))
prop_v_flower_87_frset <- as.mcmc(v_flower_87_frset / 
                                    (v_id_87_frset + v_shoot_87_frset +
                                       v_raceme_87_frset))
summary(prop_v_id_87_frset)
summary(prop_v_shoot_87_frset)
summary(prop_v_raceme_87_frset)
plot(prop_v_id_87_frset)
plot(prop_v_shoot_87_frset)
plot(prop_v_raceme_87_frset)
```

```{r}
v_id_88_frset <- (VarCorr(mod_within_among_frset_88, summary=FALSE)$id$sd)^2
v_shoot_88_frset <- (VarCorr(mod_within_among_frset_88,
                             summary=FALSE)$`id:shoot_id`$sd)^2
v_raceme_88_frset <- (VarCorr(mod_within_among_frset_88,
                              summary=FALSE)$`id:shoot_id:raceme_id`$sd)^2
v_flower_88_frset <- (VarCorr(mod_within_among_frset_88,
                              summary=FALSE)$residual$sd)^2
# No residual variance! OK?
prop_v_id_88_frset <- as.mcmc(v_id_88_frset /
                                (v_id_88_frset + v_shoot_88_frset +
                                   v_raceme_88_frset))
prop_v_shoot_88_frset <- as.mcmc(v_shoot_88_frset / 
                                   (v_id_88_frset + v_shoot_88_frset +
                                      v_raceme_88_frset))
prop_v_raceme_88_frset <- as.mcmc(v_raceme_88_frset / 
                                    (v_id_88_frset + v_shoot_88_frset +
                                       v_raceme_88_frset))
summary(prop_v_id_88_frset)
summary(prop_v_shoot_88_frset)
summary(prop_v_raceme_88_frset)
plot(prop_v_id_88_frset)
plot(prop_v_shoot_88_frset)
plot(prop_v_raceme_88_frset)
```

```{r}
v_id_89_frset <- (VarCorr(mod_within_among_frset_89, summary=FALSE)$id$sd)^2
v_shoot_89_frset <- (VarCorr(mod_within_among_frset_89,
                             summary=FALSE)$`id:shoot_id`$sd)^2
v_raceme_89_frset <- (VarCorr(mod_within_among_frset_89,
                              summary=FALSE)$`id:shoot_id:raceme_id`$sd)^2
v_flower_89_frset <- (VarCorr(mod_within_among_frset_89,
                              summary=FALSE)$residual$sd)^2
# No residual variance! OK?
prop_v_id_89_frset <- as.mcmc(v_id_89_frset /
                                (v_id_89_frset + v_shoot_89_frset +
                                   v_raceme_89_frset))
prop_v_shoot_89_frset <- as.mcmc(v_shoot_89_frset / 
                                   (v_id_89_frset + v_shoot_89_frset +
                                      v_raceme_89_frset))
prop_v_raceme_89_frset <- as.mcmc(v_raceme_89_frset / 
                                    (v_id_89_frset + v_shoot_89_frset +
                                       v_raceme_89_frset))
summary(prop_v_id_89_frset)
summary(prop_v_shoot_89_frset)
summary(prop_v_raceme_89_frset)
plot(prop_v_id_89_frset)
plot(prop_v_shoot_89_frset)
plot(prop_v_raceme_89_frset)
```

```{r}
data_props_87_frset<-full_join(
  cbind(data.frame(id_mean=summary(prop_v_id_87_frset)$statistics[1]),
        data.frame(shoot_mean=summary(prop_v_shoot_87_frset)$statistics[1]),
        data.frame(raceme_mean=summary(prop_v_raceme_87_frset)$statistics[1]))%>%
    pivot_longer(cols=c("id_mean","shoot_mean","raceme_mean"),
                 names_to="effect",values_to="mean",names_pattern="(.*)_mean"),
  cbind(data.frame(id_lower=coda::HPDinterval(prop_v_id_87_frset)[1],
                   id_upper=coda::HPDinterval(prop_v_id_87_frset)[2]),
        data.frame(shoot_lower=coda::HPDinterval(prop_v_shoot_87_frset)[1],
                   shoot_upper=coda::HPDinterval(prop_v_shoot_87_frset)[2]),
        data.frame(raceme_lower=coda::HPDinterval(prop_v_raceme_87_frset)[1],
                   raceme_upper=coda::HPDinterval(prop_v_raceme_87_frset)[2]))%>%
    pivot_longer(cols=c("id_lower","id_upper",
                        "shoot_lower","shoot_upper",
                        "raceme_lower","raceme_upper"),
                 names_to=c("effect","cat"),names_sep="_",values_to="value")%>%
    pivot_wider(names_from="cat",values_from="value"))%>%
  mutate(year=1987)
data_props_88_frset<-full_join(
  cbind(data.frame(id_mean=summary(prop_v_id_88_frset)$statistics[1]),
        data.frame(shoot_mean=summary(prop_v_shoot_88_frset)$statistics[1]),
        data.frame(raceme_mean=summary(prop_v_raceme_88_frset)$statistics[1]))%>%
    pivot_longer(cols=c("id_mean","shoot_mean","raceme_mean"),
                 names_to="effect",values_to="mean",names_pattern="(.*)_mean"),
  cbind(data.frame(id_lower=coda::HPDinterval(prop_v_id_88_frset)[1],
                   id_upper=coda::HPDinterval(prop_v_id_88_frset)[2]),
        data.frame(shoot_lower=coda::HPDinterval(prop_v_shoot_88_frset)[1],
                   shoot_upper=coda::HPDinterval(prop_v_shoot_88_frset)[2]),
        data.frame(raceme_lower=coda::HPDinterval(prop_v_raceme_88_frset)[1],
                   raceme_upper=coda::HPDinterval(prop_v_raceme_88_frset)[2]))%>%
    pivot_longer(cols=c("id_lower","id_upper",
                        "shoot_lower","shoot_upper",
                        "raceme_lower","raceme_upper"),
                 names_to=c("effect","cat"),names_sep="_",values_to="value")%>%
    pivot_wider(names_from="cat",values_from="value"))%>%
  mutate(year=1988)
data_props_89_frset<-full_join(
  cbind(data.frame(id_mean=summary(prop_v_id_89_frset)$statistics[1]),
        data.frame(shoot_mean=summary(prop_v_shoot_89_frset)$statistics[1]),
        data.frame(raceme_mean=summary(prop_v_raceme_89_frset)$statistics[1]))%>%
    pivot_longer(cols=c("id_mean","shoot_mean","raceme_mean"),
                 names_to="effect",values_to="mean",names_pattern="(.*)_mean"),
  cbind(data.frame(id_lower=coda::HPDinterval(prop_v_id_89_frset)[1],
                   id_upper=coda::HPDinterval(prop_v_id_89_frset)[2]),
        data.frame(shoot_lower=coda::HPDinterval(prop_v_shoot_89_frset)[1],
                   shoot_upper=coda::HPDinterval(prop_v_shoot_89_frset)[2]),
        data.frame(raceme_lower=coda::HPDinterval(prop_v_raceme_89_frset)[1],
                   raceme_upper=coda::HPDinterval(prop_v_raceme_89_frset)[2]))%>%
    pivot_longer(cols=c("id_lower","id_upper",
                        "shoot_lower","shoot_upper",
                        "raceme_lower","raceme_upper"),
                 names_to=c("effect","cat"),names_sep="_",values_to="value")%>%
    pivot_wider(names_from="cat",values_from="value"))%>%
  mutate(year=1989)
data_props_frset<-rbind(data_props_87_frset,
                        data_props_88_frset,
                        data_props_89_frset)%>%
  mutate(year=factor(year),
         effect=factor(effect,levels=c("id","shoot","raceme")))
```

## Seed set

```{r eval=FALSE, include=FALSE}
mod_within_among_seedset_87<-brm(seed_set~1+(1|id/shoot_id/raceme_id),
                               data=subset(data_id_flowers,year==1987),
                               family=gaussian(),
                               chains=4,cores=4,iter=10000,warmup=3000,thin=5)
# Residual variance is for flower_id
save(mod_within_among_seedset_87, 
     file = "output/models/mod_within_among_seedset_87.rda")
```

```{r eval=FALSE, include=FALSE}
mod_within_among_seedset_88<-brm(seed_set~1+(1|id/shoot_id/raceme_id),
                               data=subset(data_id_flowers,year==1988),
                               family=gaussian(),
                               chains=4,cores=4,iter=10000,warmup=3000,thin=5,
                               control=list(adapt_delta = 0.99))
# Residual variance is for flower_id
save(mod_within_among_seedset_88, 
     file = "output/models/mod_within_among_seedset_88.rda")
```

```{r eval=FALSE, include=FALSE}
mod_within_among_seedset_89<-brm(seed_set~1+(1|id/shoot_id/raceme_id),
                               data=subset(data_id_flowers,year==1989),
                               family=gaussian(),
                               chains=4,cores=4,iter=10000,warmup=3000,thin=5,
                               control=list(adapt_delta = 0.99))
# Residual variance is for flower_id
save(mod_within_among_seedset_89, 
     file = "output/models/mod_within_among_seedset_89.rda")
```

```{r}
v_id_87_seedset <- (VarCorr(mod_within_among_seedset_87, 
                            summary=FALSE)$id$sd)^2
v_shoot_87_seedset <- (VarCorr(mod_within_among_seedset_87,
                               summary=FALSE)$`id:shoot_id`$sd)^2
v_raceme_87_seedset <- (VarCorr(mod_within_among_seedset_87,
                                summary=FALSE)$`id:shoot_id:raceme_id`$sd)^2
v_flower_87_seedset <- (VarCorr(mod_within_among_seedset_87,
                                summary=FALSE)$residual$sd)^2
prop_v_id_87_seedset <- as.mcmc(v_id_87_seedset / 
                          (v_id_87_seedset + v_shoot_87_seedset +
                             v_raceme_87_seedset + v_flower_87_seedset))
prop_v_shoot_87_seedset <- as.mcmc(v_shoot_87_seedset / 
                             (v_id_87_seedset + v_shoot_87_seedset + 
                                v_raceme_87_seedset + v_flower_87_seedset))
prop_v_raceme_87_seedset <- as.mcmc(v_raceme_87_seedset / 
                              (v_id_87_seedset + v_shoot_87_seedset + 
                                 v_raceme_87_seedset + v_flower_87_seedset))
prop_v_flower_87_seedset <- as.mcmc(v_flower_87_seedset / 
                              (v_id_87_seedset + v_shoot_87_seedset + 
                                 v_raceme_87_seedset + v_flower_87_seedset))
summary(prop_v_id_87_seedset)
summary(prop_v_shoot_87_seedset)
summary(prop_v_raceme_87_seedset)
summary(prop_v_flower_87_seedset)
plot(prop_v_id_87_seedset)
plot(prop_v_shoot_87_seedset)
plot(prop_v_raceme_87_seedset)
plot(prop_v_flower_87_seedset)
```

```{r}
v_id_88_seedset <- (VarCorr(mod_within_among_seedset_88, 
                            summary=FALSE)$id$sd)^2
v_shoot_88_seedset <- (VarCorr(mod_within_among_seedset_88,
                               summary=FALSE)$`id:shoot_id`$sd)^2
v_raceme_88_seedset <- (VarCorr(mod_within_among_seedset_88,
                                summary=FALSE)$`id:shoot_id:raceme_id`$sd)^2
v_flower_88_seedset <- (VarCorr(mod_within_among_seedset_88,
                                summary=FALSE)$residual$sd)^2
prop_v_id_88_seedset <- as.mcmc(v_id_88_seedset / 
                          (v_id_88_seedset + v_shoot_88_seedset +
                             v_raceme_88_seedset + v_flower_88_seedset))
prop_v_shoot_88_seedset <- as.mcmc(v_shoot_88_seedset / 
                             (v_id_88_seedset + v_shoot_88_seedset + 
                                v_raceme_88_seedset + v_flower_88_seedset))
prop_v_raceme_88_seedset <- as.mcmc(v_raceme_88_seedset / 
                              (v_id_88_seedset + v_shoot_88_seedset + 
                                 v_raceme_88_seedset + v_flower_88_seedset))
prop_v_flower_88_seedset <- as.mcmc(v_flower_88_seedset / 
                              (v_id_88_seedset + v_shoot_88_seedset + 
                                 v_raceme_88_seedset + v_flower_88_seedset))
summary(prop_v_id_88_seedset)
summary(prop_v_shoot_88_seedset)
summary(prop_v_raceme_88_seedset)
summary(prop_v_flower_88_seedset)
plot(prop_v_id_88_seedset)
plot(prop_v_shoot_88_seedset)
plot(prop_v_raceme_88_seedset)
plot(prop_v_flower_88_seedset)
```

```{r}
v_id_89_seedset <- (VarCorr(mod_within_among_seedset_89, 
                            summary=FALSE)$id$sd)^2
v_shoot_89_seedset <- (VarCorr(mod_within_among_seedset_89,
                               summary=FALSE)$`id:shoot_id`$sd)^2
v_raceme_89_seedset <- (VarCorr(mod_within_among_seedset_89,
                                summary=FALSE)$`id:shoot_id:raceme_id`$sd)^2
v_flower_89_seedset <- (VarCorr(mod_within_among_seedset_89,
                                summary=FALSE)$residual$sd)^2
prop_v_id_89_seedset <- as.mcmc(v_id_89_seedset / 
                          (v_id_89_seedset + v_shoot_89_seedset +
                             v_raceme_89_seedset + v_flower_89_seedset))
prop_v_shoot_89_seedset <- as.mcmc(v_shoot_89_seedset / 
                             (v_id_89_seedset + v_shoot_89_seedset + 
                                v_raceme_89_seedset + v_flower_89_seedset))
prop_v_raceme_89_seedset <- as.mcmc(v_raceme_89_seedset / 
                              (v_id_89_seedset + v_shoot_89_seedset + 
                                 v_raceme_89_seedset + v_flower_89_seedset))
prop_v_flower_89_seedset <- as.mcmc(v_flower_89_seedset / 
                              (v_id_89_seedset + v_shoot_89_seedset + 
                                 v_raceme_89_seedset + v_flower_89_seedset))
summary(prop_v_id_89_seedset)
summary(prop_v_shoot_89_seedset)
summary(prop_v_raceme_89_seedset)
summary(prop_v_flower_89_seedset)
plot(prop_v_id_89_seedset)
plot(prop_v_shoot_89_seedset)
plot(prop_v_raceme_89_seedset)
plot(prop_v_flower_89_seedset)
```

```{r}
data_props_87_seedset<-full_join(
  cbind(data.frame(id_mean=summary(prop_v_id_87_seedset)$statistics[1]),
        data.frame(shoot_mean=summary(prop_v_shoot_87_seedset)$statistics[1]),
        data.frame(raceme_mean=summary(prop_v_raceme_87_seedset)$statistics[1]),
        data.frame(flower_mean=summary(prop_v_flower_87_seedset)$statistics[1]))%>%
    pivot_longer(cols=c("id_mean","shoot_mean","raceme_mean","flower_mean"),
                 names_to="effect",values_to="mean",names_pattern="(.*)_mean"),
  cbind(data.frame(id_lower=coda::HPDinterval(prop_v_id_87_seedset)[1],
                   id_upper=coda::HPDinterval(prop_v_id_87_seedset)[2]),
        data.frame(shoot_lower=coda::HPDinterval(prop_v_shoot_87_seedset)[1],
                   shoot_upper=coda::HPDinterval(prop_v_shoot_87_seedset)[2]),
        data.frame(raceme_lower=coda::HPDinterval(prop_v_raceme_87_seedset)[1],
                   raceme_upper=coda::HPDinterval(prop_v_raceme_87_seedset)[2]),
        data.frame(flower_lower=coda::HPDinterval(prop_v_flower_87_seedset)[1],
                   flower_upper=coda::HPDinterval(prop_v_flower_87_seedset)[2]))%>%
    pivot_longer(cols=c("id_lower","id_upper",
                        "shoot_lower","shoot_upper",
                        "raceme_lower","raceme_upper",
                        "flower_lower","flower_upper"),
                 names_to=c("effect","cat"),names_sep="_",values_to="value")%>%
    pivot_wider(names_from="cat",values_from="value"))%>%
  mutate(year=1987)
data_props_88_seedset<-full_join(
  cbind(data.frame(id_mean=summary(prop_v_id_88_seedset)$statistics[1]),
        data.frame(shoot_mean=summary(prop_v_shoot_88_seedset)$statistics[1]),
        data.frame(raceme_mean=summary(prop_v_raceme_88_seedset)$statistics[1]),
        data.frame(flower_mean=summary(prop_v_flower_88_seedset)$statistics[1]))%>%
    pivot_longer(cols=c("id_mean","shoot_mean","raceme_mean","flower_mean"),
                 names_to="effect",values_to="mean",names_pattern="(.*)_mean"),
  cbind(data.frame(id_lower=coda::HPDinterval(prop_v_id_88_seedset)[1],
                   id_upper=coda::HPDinterval(prop_v_id_88_seedset)[2]),
        data.frame(shoot_lower=coda::HPDinterval(prop_v_shoot_88_seedset)[1],
                   shoot_upper=coda::HPDinterval(prop_v_shoot_88_seedset)[2]),
        data.frame(raceme_lower=coda::HPDinterval(prop_v_raceme_88_seedset)[1],
                   raceme_upper=coda::HPDinterval(prop_v_raceme_88_seedset)[2]),
        data.frame(flower_lower=coda::HPDinterval(prop_v_flower_88_seedset)[1],
                   flower_upper=coda::HPDinterval(prop_v_flower_88_seedset)[2]))%>%
    pivot_longer(cols=c("id_lower","id_upper",
                        "shoot_lower","shoot_upper",
                        "raceme_lower","raceme_upper",
                        "flower_lower","flower_upper"),
                 names_to=c("effect","cat"),names_sep="_",values_to="value")%>%
    pivot_wider(names_from="cat",values_from="value"))%>%
  mutate(year=1988)
data_props_89_seedset<-full_join(
  cbind(data.frame(id_mean=summary(prop_v_id_89_seedset)$statistics[1]),
        data.frame(shoot_mean=summary(prop_v_shoot_89_seedset)$statistics[1]),
        data.frame(raceme_mean=summary(prop_v_raceme_89_seedset)$statistics[1]),
        data.frame(flower_mean=summary(prop_v_flower_89_seedset)$statistics[1]))%>%
    pivot_longer(cols=c("id_mean","shoot_mean","raceme_mean","flower_mean"),
                 names_to="effect",values_to="mean",names_pattern="(.*)_mean"),
  cbind(data.frame(id_lower=coda::HPDinterval(prop_v_id_89_seedset)[1],
                   id_upper=coda::HPDinterval(prop_v_id_89_seedset)[2]),
        data.frame(shoot_lower=coda::HPDinterval(prop_v_shoot_89_seedset)[1],
                   shoot_upper=coda::HPDinterval(prop_v_shoot_89_seedset)[2]),
        data.frame(raceme_lower=coda::HPDinterval(prop_v_raceme_89_seedset)[1],
                   raceme_upper=coda::HPDinterval(prop_v_raceme_89_seedset)[2]),
        data.frame(flower_lower=coda::HPDinterval(prop_v_flower_89_seedset)[1],
                   flower_upper=coda::HPDinterval(prop_v_flower_89_seedset)[2]))%>%
    pivot_longer(cols=c("id_lower","id_upper",
                        "shoot_lower","shoot_upper",
                        "raceme_lower","raceme_upper",
                        "flower_lower","flower_upper"),
                 names_to=c("effect","cat"),names_sep="_",values_to="value")%>%
    pivot_wider(names_from="cat",values_from="value"))%>%
  mutate(year=1989)
data_props_seedset<-rbind(data_props_87_seedset,data_props_88_seedset,
                          data_props_89_seedset)%>%
  mutate(year=factor(year),
         effect=factor(effect,levels=c("id","shoot","raceme","flower")))
```

## Figure 2

```{r}
ggplot(rbind(data_props%>%mutate(type="Opening date"),
             data_props_frset%>%mutate(type="Fruit set"),
             data_props_seedset%>%mutate(type="Seed set"))%>%
         mutate(type=factor(type,
                            levels=c("Opening date","Fruit set","Seed set"))),
       aes(x=year,y=mean,ymin=lower,ymax=upper,color=effect))+
  geom_errorbar(linewidth=0.5,width=0.2,position=position_dodge(0.3))+
  geom_point(size=2,position=position_dodge(0.3))+facet_wrap(~type)+
  my_theme_legend()+xlab(NULL)+ylab("Proportion of variance")+
  theme(legend.position="top")
ggsave(filename="output/figures/fig2.tiff",
       width=25,height=10,units="cm",dpi=300)
```

## Appendix S1: Diagnostics

```{r}
color_scheme_set("viridis")
```

## Opening date

### 1987 

```{r}
array_mod_within_among_87<-as.array(mod_within_among_87)
dimnames(array_mod_within_among_87)[[3]][1:5] <-
  c("Intercept","Individual: SD (intercept)","Shoot: SD (intercept)",
    "Raceme: SD (intercept)","Sigma")
mcmc_trace(array_mod_within_among_87,
           pars=c("Intercept","Individual: SD (intercept)",
                  "Shoot: SD (intercept)","Raceme: SD (intercept)","Sigma"),
                          facet_args = list(ncol = 1, strip.position = "left"))
ggsave(filename="output/figures/AppS1_1.tiff",
        device="tiff",width=20,height=26,units="cm",dpi=300,compression="lzw")
```

```{r}
plot_grid(mcmc_rhat_hist(brms::rhat(mod_within_among_87))+
            my_theme_legend()+
            theme(legend.position="top")+
            theme(legend.text=element_text(size=10)),
          mcmc_neff_hist(neff_ratio(mod_within_among_87))+
            my_theme_legend()+
            theme(legend.position="top")+
            theme(legend.text=element_text(size=10)),
          labels = c("A)","B)"),label_fontfamily="serif")
ggsave(filename="output/figures/AppS1_2.tiff",
       device="tiff",width=20,height=10,units="cm",dpi=300,compression="lzw")
```

```{r}
y1<-subset(data_id_flowers, year == 1987)$opening_date_v 
# vector of outcome values
yrep3<-posterior_predict(mod_within_among_87, draws = 500)
# matrix of draws from the posterior predictive distribution
ppc_dens_overlay(y1, yrep3[1:100,])+my_theme_legend()+
  theme(axis.ticks.y = element_blank(),axis.text.y = element_blank())
ggsave(filename="output/figures/AppS1_3.tiff",
       device="tiff",width=12,height=8,units="cm",dpi=300,compression="lzw")
```

### 1988

```{r}
array_mod_within_among_88<-as.array(mod_within_among_88)
dimnames(array_mod_within_among_88)[[3]][1:5] <-
  c("Intercept","Individual: SD (intercept)","Shoot: SD (intercept)",
    "Raceme: SD (intercept)","Sigma")
mcmc_trace(array_mod_within_among_88,
           pars=c("Intercept","Individual: SD (intercept)",
                  "Shoot: SD (intercept)","Raceme: SD (intercept)","Sigma"),
                          facet_args = list(ncol = 1, strip.position = "left"))
ggsave(filename="output/figures/AppS1_4.tiff",
        device="tiff",width=20,height=26,units="cm",dpi=300,compression="lzw")
```

```{r}
plot_grid(mcmc_rhat_hist(brms::rhat(mod_within_among_88))+
            my_theme_legend()+
            theme(legend.position="top")+
            theme(legend.text=element_text(size=10)),
          mcmc_neff_hist(neff_ratio(mod_within_among_88))+
            my_theme_legend()+
            theme(legend.position="top")+
            theme(legend.text=element_text(size=10)),
          labels = c("A)","B)"),label_fontfamily="serif")
ggsave(filename="output/figures/AppS1_5.tiff",
       device="tiff",width=20,height=10,units="cm",dpi=300,compression="lzw")
```

```{r}
y1<-subset(data_id_flowers, year == 1988)$opening_date_v 
# vector of outcome values
yrep3<-posterior_predict(mod_within_among_88, draws = 500)
# matrix of draws from the posterior predictive distribution
ppc_dens_overlay(y1, yrep3[1:100,])+my_theme_legend()+
  theme(axis.ticks.y = element_blank(),axis.text.y = element_blank())
ggsave(filename="output/figures/AppS1_6.tiff",
       device="tiff",width=12,height=8,units="cm",dpi=300,compression="lzw")
```

### 1989

```{r}
array_mod_within_among_89<-as.array(mod_within_among_89)
dimnames(array_mod_within_among_89)[[3]][1:5] <-
  c("Intercept","Individual: SD (intercept)","Shoot: SD (intercept)",
    "Raceme: SD (intercept)","Sigma")
mcmc_trace(array_mod_within_among_89,
           pars=c("Intercept","Individual: SD (intercept)",
                  "Shoot: SD (intercept)","Raceme: SD (intercept)","Sigma"),
                          facet_args = list(ncol = 1, strip.position = "left"))
ggsave(filename="output/figures/AppS1_7.tiff",
        device="tiff",width=20,height=26,units="cm",dpi=300,compression="lzw")
```

```{r}
plot_grid(mcmc_rhat_hist(brms::rhat(mod_within_among_89))+
            my_theme_legend()+
            theme(legend.position="top")+
            theme(legend.text=element_text(size=10)),
          mcmc_neff_hist(neff_ratio(mod_within_among_89))+
            my_theme_legend()+
            theme(legend.position="top")+
            theme(legend.text=element_text(size=10)),
          labels = c("A)","B)"),label_fontfamily="serif")
ggsave(filename="output/figures/AppS1_8.tiff",
       device="tiff",width=20,height=10,units="cm",dpi=300,compression="lzw")
```

```{r}
y1<-subset(data_id_flowers, year == 1989)$opening_date_v 
# vector of outcome values
yrep3<-posterior_predict(mod_within_among_89, draws = 500)
# matrix of draws from the posterior predictive distribution
ppc_dens_overlay(y1, yrep3[1:100,])+my_theme_legend()+
  theme(axis.ticks.y = element_blank(),axis.text.y = element_blank())
ggsave(filename="output/figures/AppS1_9.tiff",
       device="tiff",width=12,height=8,units="cm",dpi=300,compression="lzw")
```

## Fruit set

### 1987 

```{r}
array_mod_within_among_frset_87<-as.array(mod_within_among_frset_87)
dimnames(array_mod_within_among_frset_87)[[3]][1:4] <-
  c("Intercept","Individual: SD (intercept)","Shoot: SD (intercept)",
    "Raceme: SD (intercept)")
mcmc_trace(array_mod_within_among_87,
           pars=c("Intercept","Individual: SD (intercept)",
                  "Shoot: SD (intercept)","Raceme: SD (intercept)"),
                          facet_args = list(ncol = 1, strip.position = "left"))
ggsave(filename="output/figures/AppS1_10.tiff",
        device="tiff",width=20,height=26,units="cm",dpi=300,compression="lzw")
```

```{r}
plot_grid(mcmc_rhat_hist(brms::rhat(mod_within_among_frset_87))+
            my_theme_legend()+
            theme(legend.position="top")+
            theme(legend.text=element_text(size=10)),
          mcmc_neff_hist(neff_ratio(mod_within_among_frset_87))+
            my_theme_legend()+
            theme(legend.position="top")+
            theme(legend.text=element_text(size=10)),
          labels = c("A)","B)"),label_fontfamily="serif")
ggsave(filename="output/figures/AppS1_11.tiff",
       device="tiff",width=20,height=10,units="cm",dpi=300,compression="lzw")
```

```{r}
y1<-subset(data_id_flowers, year == 1987)$fruit_set 
# vector of outcome values
yrep3<-posterior_predict(mod_within_among_frset_87, draws = 500)
# matrix of draws from the posterior predictive distribution
ppc_dens_overlay(y1, yrep3[1:100,])+my_theme_legend()+
  theme(axis.ticks.y = element_blank(),axis.text.y = element_blank())
ggsave(filename="output/figures/AppS1_12.tiff",
       device="tiff",width=12,height=8,units="cm",dpi=300,compression="lzw")
```

### 1988

```{r}
array_mod_within_among_frset_88<-as.array(mod_within_among_frset_88)
dimnames(array_mod_within_among_frset_88)[[3]][1:4] <-
  c("Intercept","Individual: SD (intercept)","Shoot: SD (intercept)",
    "Raceme: SD (intercept)")
mcmc_trace(array_mod_within_among_88,
           pars=c("Intercept","Individual: SD (intercept)",
                  "Shoot: SD (intercept)","Raceme: SD (intercept)"),
                          facet_args = list(ncol = 1, strip.position = "left"))
ggsave(filename="output/figures/AppS1_13.tiff",
        device="tiff",width=20,height=26,units="cm",dpi=300,compression="lzw")
```

```{r}
plot_grid(mcmc_rhat_hist(brms::rhat(mod_within_among_frset_88))+
            my_theme_legend()+
            theme(legend.position="top")+
            theme(legend.text=element_text(size=10)),
          mcmc_neff_hist(neff_ratio(mod_within_among_frset_88))+
            my_theme_legend()+
            theme(legend.position="top")+
            theme(legend.text=element_text(size=10)),
          labels = c("A)","B)"),label_fontfamily="serif")
ggsave(filename="output/figures/AppS1_14.tiff",
       device="tiff",width=20,height=10,units="cm",dpi=300,compression="lzw")
```

```{r}
y1<-subset(data_id_flowers, year == 1988)$fruit_set 
# vector of outcome values
yrep3<-posterior_predict(mod_within_among_frset_88, draws = 500)
# matrix of draws from the posterior predictive distribution
ppc_dens_overlay(y1, yrep3[1:100,])+my_theme_legend()+
  theme(axis.ticks.y = element_blank(),axis.text.y = element_blank())
ggsave(filename="output/figures/AppS1_15.tiff",
       device="tiff",width=12,height=8,units="cm",dpi=300,compression="lzw")
```

### 1989

```{r}
array_mod_within_among_frset_89<-as.array(mod_within_among_frset_89)
dimnames(array_mod_within_among_frset_89)[[3]][1:4] <-
  c("Intercept","Individual: SD (intercept)","Shoot: SD (intercept)",
    "Raceme: SD (intercept)")
mcmc_trace(array_mod_within_among_89,
           pars=c("Intercept","Individual: SD (intercept)",
                  "Shoot: SD (intercept)","Raceme: SD (intercept)"),
                          facet_args = list(ncol = 1, strip.position = "left"))
ggsave(filename="output/figures/AppS1_16.tiff",
        device="tiff",width=20,height=26,units="cm",dpi=300,compression="lzw")
```

```{r}
plot_grid(mcmc_rhat_hist(brms::rhat(mod_within_among_frset_89))+
            my_theme_legend()+
            theme(legend.position="top")+
            theme(legend.text=element_text(size=10)),
          mcmc_neff_hist(neff_ratio(mod_within_among_frset_89))+
            my_theme_legend()+
            theme(legend.position="top")+
            theme(legend.text=element_text(size=10)),
          labels = c("A)","B)"),label_fontfamily="serif")
ggsave(filename="output/figures/AppS1_17.tiff",
       device="tiff",width=20,height=10,units="cm",dpi=300,compression="lzw")
```

```{r}
y1<-subset(data_id_flowers, year == 1989)$fruit_set 
# vector of outcome values
yrep3<-posterior_predict(mod_within_among_frset_89, draws = 500)
# matrix of draws from the posterior predictive distribution
ppc_dens_overlay(y1, yrep3[1:100,])+my_theme_legend()+
  theme(axis.ticks.y = element_blank(),axis.text.y = element_blank())
ggsave(filename="output/figures/AppS1_18.tiff",
       device="tiff",width=12,height=8,units="cm",dpi=300,compression="lzw")
```

## Seed set

### 1987 

```{r}
array_mod_within_among_seedset_87<-as.array(mod_within_among_seedset_87)
dimnames(array_mod_within_among_seedset_87)[[3]][1:5] <-
  c("Intercept","Individual: SD (intercept)","Shoot: SD (intercept)",
    "Raceme: SD (intercept)","Sigma")
mcmc_trace(array_mod_within_among_seedset_87,
           pars=c("Intercept","Individual: SD (intercept)",
                  "Shoot: SD (intercept)","Raceme: SD (intercept)","Sigma"),
                          facet_args = list(ncol = 1, strip.position = "left"))
ggsave(filename="output/figures/AppS1_19.tiff",
        device="tiff",width=20,height=26,units="cm",dpi=300,compression="lzw")
```

```{r}
plot_grid(mcmc_rhat_hist(brms::rhat(mod_within_among_seedset_87))+
            my_theme_legend()+
            theme(legend.position="top")+
            theme(legend.text=element_text(size=10)),
          mcmc_neff_hist(neff_ratio(mod_within_among_seedset_87))+
            my_theme_legend()+
            theme(legend.position="top")+
            theme(legend.text=element_text(size=10)),
          labels = c("A)","B)"),label_fontfamily="serif")
ggsave(filename="output/figures/AppS1_20.tiff",
       device="tiff",width=20,height=10,units="cm",dpi=300,compression="lzw")
```

```{r}
y1<-subset(data_id_flowers, year == 1987&!is.na(seed_set))$seed_set 
# vector of outcome values
yrep3<-posterior_predict(mod_within_among_seedset_87, draws = 500)
# matrix of draws from the posterior predictive distribution
ppc_dens_overlay(y1, yrep3[1:100,])+my_theme_legend()+
  theme(axis.ticks.y = element_blank(),axis.text.y = element_blank())
ggsave(filename="output/figures/AppS1_21.tiff",
       device="tiff",width=12,height=8,units="cm",dpi=300,compression="lzw")
```

### 1988

```{r}
array_mod_within_among_seedset_88<-as.array(mod_within_among_seedset_88)
dimnames(array_mod_within_among_seedset_88)[[3]][1:5] <-
  c("Intercept","Individual: SD (intercept)","Shoot: SD (intercept)",
    "Raceme: SD (intercept)","Sigma")
mcmc_trace(array_mod_within_among_seedset_88,
           pars=c("Intercept","Individual: SD (intercept)",
                  "Shoot: SD (intercept)","Raceme: SD (intercept)","Sigma"),
                          facet_args = list(ncol = 1, strip.position = "left"))
ggsave(filename="output/figures/AppS1_22.tiff",
        device="tiff",width=20,height=26,units="cm",dpi=300,compression="lzw")
```

```{r}
plot_grid(mcmc_rhat_hist(brms::rhat(mod_within_among_seedset_88))+
            my_theme_legend()+
            theme(legend.position="top")+
            theme(legend.text=element_text(size=10)),
          mcmc_neff_hist(neff_ratio(mod_within_among_seedset_88))+
            my_theme_legend()+
            theme(legend.position="top")+
            theme(legend.text=element_text(size=10)),
          labels = c("A)","B)"),label_fontfamily="serif")
ggsave(filename="output/figures/AppS1_23.tiff",
       device="tiff",width=20,height=10,units="cm",dpi=300,compression="lzw")
```

```{r}
y1<-subset(data_id_flowers, year == 1988&!is.na(seed_set))$seed_set 
# vector of outcome values
yrep3<-posterior_predict(mod_within_among_seedset_88, draws = 500)
# matrix of draws from the posterior predictive distribution
ppc_dens_overlay(y1, yrep3[1:100,])+my_theme_legend()+
  theme(axis.ticks.y = element_blank(),axis.text.y = element_blank())
ggsave(filename="output/figures/AppS1_24.tiff",
       device="tiff",width=12,height=8,units="cm",dpi=300,compression="lzw")
```

### 1989

```{r}
array_mod_within_among_seedset_89<-as.array(mod_within_among_seedset_89)
dimnames(array_mod_within_among_seedset_89)[[3]][1:5] <-
  c("Intercept","Individual: SD (intercept)","Shoot: SD (intercept)",
    "Raceme: SD (intercept)","Sigma")
mcmc_trace(array_mod_within_among_seedset_89,
           pars=c("Intercept","Individual: SD (intercept)",
                  "Shoot: SD (intercept)","Raceme: SD (intercept)","Sigma"),
                          facet_args = list(ncol = 1, strip.position = "left"))
ggsave(filename="output/figures/AppS1_25.tiff",
        device="tiff",width=20,height=26,units="cm",dpi=300,compression="lzw")
```

```{r}
plot_grid(mcmc_rhat_hist(brms::rhat(mod_within_among_seedset_89))+
            my_theme_legend()+
            theme(legend.position="top")+
            theme(legend.text=element_text(size=10)),
          mcmc_neff_hist(neff_ratio(mod_within_among_seedset_89))+
            my_theme_legend()+
            theme(legend.position="top")+
            theme(legend.text=element_text(size=10)),
          labels = c("A)","B)"),label_fontfamily="serif")
ggsave(filename="output/figures/AppS1_26.tiff",
       device="tiff",width=20,height=10,units="cm",dpi=300,compression="lzw")
```

```{r}
y1<-subset(data_id_flowers, year == 1989&!is.na(seed_set))$seed_set 
# vector of outcome values
yrep3<-posterior_predict(mod_within_among_seedset_89, draws = 500)
# matrix of draws from the posterior predictive distribution
ppc_dens_overlay(y1, yrep3[1:100,])+my_theme_legend()+
  theme(axis.ticks.y = element_blank(),axis.text.y = element_blank())
ggsave(filename="output/figures/AppS1_27.tiff",
       device="tiff",width=12,height=8,units="cm",dpi=300,compression="lzw")
```

# Q2: Effects of flower position on opening date

```{r}
mod_phen_87<-glmmTMB(opening_date_v~relpos_fl*relpos_rac+
                       (1|id/shoot_id/raceme_id),
               subset(data_id_flowers,year==1987))
mod_phen_88<-glmmTMB(opening_date_v~relpos_fl*relpos_rac+
                       (1|id/shoot_id/raceme_id),
               subset(data_id_flowers,year==1988))
mod_phen_89<-glmmTMB(opening_date_v~relpos_fl*relpos_rac+
                       (1|id/shoot_id/raceme_id),
               subset(data_id_flowers,year==1989))
# OK with random factors and nesting?
summary(mod_phen_87)
summary(mod_phen_88)
summary(mod_phen_89)
```

Interaction significant in all years.

## Diagnostics

```{r}
plot(simulateResiduals(mod_phen_87,n=1000))
plot(simulateResiduals(mod_phen_88,n=1000))
plot(simulateResiduals(mod_phen_89,n=1000))
```

## Check for singular fit

```{r}
check_singularity(mod_phen_87)
check_singularity(mod_phen_88)
check_singularity(mod_phen_89)
```
## Table 1

```{r}
tab_model(mod_phen_87,mod_phen_88,mod_phen_89,
          transform=NULL,show.intercept=F,show.ci=F,show.se=T,show.stat=T,
          show.r2=T,show.icc=F,show.re.var=F,show.ngroups=F,digits=3,
          dv.labels=c("1987","1988","1989"),
          file="output/tables/Table1.doc")
```

## Figure 3

```{r}
fig3<-ggplot()+
  geom_line(data=rbind(data.frame(ggpredict(mod_phen_87,
                                            terms=c("relpos_fl[all]",
                                                    "relpos_rac[all]")))%>%
                         mutate(year="1987"),
                       data.frame(ggpredict(mod_phen_88,
                                            terms=c("relpos_fl[all]",
                                                    "relpos_rac[all]")))%>%
                         mutate(year="1988"),
                       data.frame(ggpredict(mod_phen_89,
                                            terms=c("relpos_fl[all]","
                                                    relpos_rac[all]")))%>%
                         mutate(year="1989"))%>%mutate(year=as.factor(year)),
            aes(x=x,y=predicted,group=group,color=as.numeric(group)))+
  facet_wrap(~year)+
  my_theme_legend()+xlab("Flower position")+ylab("Opening date")+
  labs(fill="Raceme position",
       color="Raceme position")+
  theme(legend.position="top")+scale_color_viridis(option="D")
ggsave(filename="output/figures/fig3.tiff",plot=fig3,
       width=20,height=12,units="cm",dpi=300,compression="lzw")
```

Basal flowers (lower relpos_fl) open earlier than distal flowers within the raceme.
Flowers on basal racemes (lower relpos_rac) open earlier than flowers on distal racemes.

Basal flowers on basal racemes (lower relpos_fl and lower relpos_rac) open the earliest, and distal flowers on distal racemes (higher relpos_fl and higher relpos_rac) open the latest.

# Q3: Effects on reproductive success due to phenology vs. other effects

Check distributions:

```{r}
hist(data_id_flowers$fruit_set)
hist(data_id_flowers$seed_set)
```

## Fruit set

Fit models with interaction between position effects:

```{r}
mod_frset_phen_87<-glmmTMB(fruit_set~relpos_fl*relpos_rac+opening_date_v+
                      (1|id/shoot_id/raceme_id),
                    subset(data_id_flowers,year==1987),family="binomial")
mod_frset_phen_88<-glmmTMB(fruit_set~relpos_fl*relpos_rac+opening_date_v+
                      (1|id/shoot_id/raceme_id),
                    subset(data_id_flowers,year==1988),family="binomial")
mod_frset_phen_89<-glmmTMB(fruit_set~relpos_fl*relpos_rac+opening_date_v+
                      (1|id/shoot_id/raceme_id),
                    subset(data_id_flowers,year==1989),family="binomial")
# OK with random factors and nesting?
summary(mod_frset_phen_87) # Interaction *
summary(mod_frset_phen_88) # Interaction NS
summary(mod_frset_phen_89) # interaction NS
```

For 1988 and 1989, refit models without interaction:

```{r}
mod_frset_phen_88<-glmmTMB(fruit_set~relpos_fl+relpos_rac+opening_date_v+
                      (1|id/shoot_id/raceme_id),
                    subset(data_id_flowers,year==1988),family="binomial")
mod_frset_phen_89<-glmmTMB(fruit_set~relpos_fl+relpos_rac+opening_date_v+
                      (1|id/shoot_id/raceme_id),
                    subset(data_id_flowers,year==1989),family="binomial")
# OK with random factors and nesting?
summary(mod_frset_phen_88)
summary(mod_frset_phen_89)
```


Flowers opening earlier have a higher probability of setting fruit. 

1988 and 1989: Basal flowers (lower relpos_fl) have a higher probability of initiating fruit than distal flowers within the raceme. 

The effect of flower position among racemes seems to be mainly due to different phenologies of individual flowers, and the effect of flower position within the raceme seems to be mainly due to different resource accessibility. 

Build the piecewise SEMs:

```{r}
path_frset_87<-psem(mod_frset_phen_87,mod_phen_87)
path_frset_88<-psem(mod_frset_phen_88,mod_phen_88)
path_frset_89<-psem(mod_frset_phen_89,mod_phen_89)
```

```{r}
summary(path_frset_87)
summary(path_frset_88)
summary(path_frset_89)
```

Models for fruit set are singular (checked using performance::check_singularity).
Singularity disappears when removing random effects of raceme_id and shoot_id.
Only problem is for calculating R squared values (that we so far not show in the figure), so OK so far. If we want to show models without those random effects not included, results in terms of coefficients, etc are similar. 

Plots:

```{r}
plot_path_frset_87<-plot(path_frset_87,layout="tree",
                          node_attrs=data.frame(shape="rectangle",
                                                color="black",fillcolor="white",
                                                fontsize=8,
                                                fontname="Times-Roman",
                                                fixedsize=F),
                          edge_attrs=data.frame(style="solid",color="grey",
                                                fontsize=8,
                                                fontname="Times-Roman"),
                          title="1987")
plot_path_frset_88<-plot(path_frset_88,layout="tree",
                         node_attrs=data.frame(shape="rectangle",
                                               color="black",fillcolor="white",
                                               fontsize=8,
                                               fontname="Times-Roman",
                                               fixedsize=F),
                         edge_attrs=data.frame(style="solid",color="grey",
                                               fontsize=8,
                                               fontname="Times-Roman"),
                         title="1988")
plot_path_frset_89<-plot(path_frset_89,layout="tree",
                         node_attrs=data.frame(shape="rectangle",
                                               color="black",fillcolor="white",
                                               fontsize=8,
                                               fontname="Times-Roman",
                                               fixedsize=F),
                         edge_attrs=data.frame(style="solid",color="grey",
                                               fontsize=8,
                                               fontname="Times-Roman"),
     title="1989")
```

```{r}
save_png(plot_path_frset_87,"output/figures/plot_path_frset_87.png")
save_png(plot_path_frset_88,"output/figures/plot_path_frset_88.png")
save_png(plot_path_frset_89,"output/figures/plot_path_frset_89.png")
writeLines(export_svg(plot_path_frset_87),
           "output/figures/plot_path_frset_87.svg")
writeLines(export_svg(plot_path_frset_88),
           "output/figures/plot_path_frset_88.svg")
writeLines(export_svg(plot_path_frset_89),
           "output/figures/plot_path_frset_89.svg")
```

## Seed set

Fit models with interaction between position effects:

```{r}
mod_seedset_phen_87<-glmmTMB(seed_set~relpos_fl*relpos_rac+opening_date_v+
                               (1|id/shoot_id/raceme_id),
                             subset(data_id_flowers,year==1987),
                             family="binomial",weights=n_ovules)
mod_seedset_phen_88<-glmmTMB(seed_set~relpos_fl*relpos_rac+opening_date_v+
                               (1|id/shoot_id/raceme_id),
                             subset(data_id_flowers,year==1988),
                             family="binomial",weights=n_ovules)
mod_seedset_phen_89<-glmmTMB(seed_set~relpos_fl*relpos_rac+opening_date_v+
                               (1|id/shoot_id/raceme_id),
                             subset(data_id_flowers,year==1989),
                             family="binomial",weights=n_ovules)
# OK with random factors and nesting?
summary(mod_seedset_phen_87)
summary(mod_seedset_phen_88)
summary(mod_seedset_phen_89)
```

Interaction never significant, refit models without interaction:

```{r}
mod_seedset_phen_87<-glmmTMB(seed_set~relpos_fl+relpos_rac+opening_date_v+
                               (1|id/shoot_id/raceme_id),
                             subset(data_id_flowers,year==1987),
                             family="binomial",weights=n_ovules)
mod_seedset_phen_88<-glmmTMB(seed_set~relpos_fl+relpos_rac+opening_date_v+
                               (1|id/shoot_id/raceme_id),
                             subset(data_id_flowers,year==1988),
                             family="binomial",weights=n_ovules)
mod_seedset_phen_89<-glmmTMB(seed_set~relpos_fl+relpos_rac+opening_date_v+
                               (1|id/shoot_id/raceme_id),
                             subset(data_id_flowers,year==1989),
                             family="binomial",weights=n_ovules)
# OK with random factors and nesting?
summary(mod_seedset_phen_87)
summary(mod_seedset_phen_88)
summary(mod_seedset_phen_89)
```


Reduced models for phenology, with the same n as models for seed set. Fit models with interaction:

```{r}
mod_phen_reduced_87<-glmmTMB(opening_date_v~relpos_fl*relpos_rac+
                       (1|id/shoot_id/raceme_id),
               subset(data_id_flowers,year==1987&!is.na(n_ovules)))
mod_phen_reduced_88<-glmmTMB(opening_date_v~relpos_fl*relpos_rac+
                       (1|id/shoot_id/raceme_id),
               subset(data_id_flowers,year==1988&!is.na(n_ovules)))
mod_phen_reduced_89<-glmmTMB(opening_date_v~relpos_fl*relpos_rac+
                       (1|id/shoot_id/raceme_id),
               subset(data_id_flowers,year==1989&!is.na(n_ovules)))
summary(mod_phen_reduced_87)
summary(mod_phen_reduced_88)
summary(mod_phen_reduced_89)
```

Interaction never significant, refit models without interaction:

```{r}
mod_phen_reduced_87<-glmmTMB(opening_date_v~relpos_fl+relpos_rac+
                       (1|id/shoot_id/raceme_id),
               subset(data_id_flowers,year==1987&!is.na(n_ovules)))
mod_phen_reduced_88<-glmmTMB(opening_date_v~relpos_fl+relpos_rac+
                       (1|id/shoot_id/raceme_id),
               subset(data_id_flowers,year==1988&!is.na(n_ovules)))
mod_phen_reduced_89<-glmmTMB(opening_date_v~relpos_fl+relpos_rac+
                       (1|id/shoot_id/raceme_id),
               subset(data_id_flowers,year==1989&!is.na(n_ovules)))
summary(mod_phen_reduced_87)
summary(mod_phen_reduced_88)
summary(mod_phen_reduced_89)
```


Build the piecewise SEMs:

```{r}
path_seedset_87<-psem(mod_seedset_phen_87,mod_phen_87)
path_seedset_88<-psem(mod_seedset_phen_88,mod_phen_88)
path_seedset_89<-psem(mod_seedset_phen_89,mod_phen_89)
```

```{r}
summary(path_seedset_87)
summary(path_seedset_88)
summary(path_seedset_89)
```

Models for seed set are singular (except for 1989 - checked using performance::check_singularity).
Singularity disappears when removing random effects of raceme_id and shoot_id.
Only problem is for calculating R squared values (that we so far not show in the figure), so OK so far. If we want to show models without those random effects not included, results in terms of coefficients, etc are similar. 

Plots:

```{r}
plot_path_seedset_87<-plot(path_seedset_87,layout="tree",
                          node_attrs=data.frame(shape="rectangle",
                                                color="black",fillcolor="white",
                                                fontsize=8,
                                                fontname="Times-Roman",
                                                fixedsize=F),
                          edge_attrs=data.frame(style="solid",color="grey",
                                                fontsize=8,
                                                fontname="Times-Roman"),
                          title="1987")
plot_path_seedset_88<-plot(path_seedset_88,layout="tree",
                         node_attrs=data.frame(shape="rectangle",
                                               color="black",fillcolor="white",
                                               fontsize=8,
                                               fontname="Times-Roman",
                                               fixedsize=F),
                         edge_attrs=data.frame(style="solid",color="grey",
                                               fontsize=8,
                                               fontname="Times-Roman"),
                         title="1988")
plot_path_seedset_89<-plot(path_seedset_89,layout="tree",
                         node_attrs=data.frame(shape="rectangle",
                                               color="black",fillcolor="white",
                                               fontsize=8,
                                               fontname="Times-Roman",
                                               fixedsize=F),
                         edge_attrs=data.frame(style="solid",color="grey",
                                               fontsize=8,
                                               fontname="Times-Roman"),
     title="1989")
```

```{r}
save_png(plot_path_seedset_87,"output/figures/plot_path_seedset_87.png")
save_png(plot_path_seedset_88,"output/figures/plot_path_seedset_88.png")
save_png(plot_path_seedset_89,"output/figures/plot_path_seedset_89.png")
writeLines(export_svg(plot_path_seedset_87),
           "output/figures/plot_path_seedset_87.svg")
writeLines(export_svg(plot_path_seedset_88),
           "output/figures/plot_path_seedset_88.svg")
writeLines(export_svg(plot_path_seedset_89),
           "output/figures/plot_path_seedset_89.svg")
```

## Appendix S2

```{r}
AppS2<-ggplot()+
  geom_line(data=ggpredict(mod_frset_phen_87,
                           terms=c("relpos_fl[all]","relpos_rac[all]")),
            aes(x=x,y=predicted,group=group,color=as.numeric(group)))+
  my_theme_legend()+xlab("Flower position")+ylab("Fruit set")+
  labs(fill="Raceme position",
       color="Raceme position")+
  theme(legend.position="top")+scale_color_viridis(option="D")
AppS2
ggsave(filename="output/figures/AppS2.tiff",plot=AppS2,
       width=11,height=12,units="cm",dpi=300,compression="lzw")
```


# Q4: Effects on seed predation success due to phenology vs. other effects

Fit models with interaction between position effects:

```{r}
mod_seedpred_phen_87<-glmmTMB(prop_pred_seeds~relpos_fl*relpos_rac+
                                opening_date_v+(1|id/shoot_id/raceme_id),
                    subset(data_id_flowers,year==1987),family="binomial",
                    weights=n_seeds)
mod_seedpred_phen_88<-glmmTMB(prop_pred_seeds~relpos_fl*relpos_rac+
                                opening_date_v+(1|id/shoot_id/raceme_id),
                    subset(data_id_flowers,year==1988),family="binomial",
                    weights=n_seeds)
mod_seedpred_phen_89<-glmmTMB(prop_pred_seeds~relpos_fl*relpos_rac+
                                opening_date_v+(1|id/shoot_id/raceme_id),
                    subset(data_id_flowers,year==1989),family="binomial",
                    weights=n_seeds)
# OK with random factors and nesting?
summary(mod_seedpred_phen_87) # Interaction NS
summary(mod_seedpred_phen_88) # Interaction NS
summary(mod_seedpred_phen_89) # interaction NS
```

Interaction not significant in any of the years. Refit models without interaction.

```{r}
mod_seedpred_phen_87<-glmmTMB(prop_pred_seeds~relpos_fl+relpos_rac+
                                opening_date_v+(1|id/shoot_id/raceme_id),
                    subset(data_id_flowers,year==1987),family="binomial",
                    weights=n_seeds)
mod_seedpred_phen_88<-glmmTMB(prop_pred_seeds~relpos_fl+relpos_rac+
                                opening_date_v+(1|id/shoot_id/raceme_id),
                    subset(data_id_flowers,year==1988),family="binomial",
                    weights=n_seeds)
mod_seedpred_phen_89<-glmmTMB(prop_pred_seeds~relpos_fl+relpos_rac+
                                opening_date_v+(1|id/shoot_id/raceme_id),
                    subset(data_id_flowers,year==1989),family="binomial",
                    weights=n_seeds)
# OK with random factors and nesting?
summary(mod_seedpred_phen_87)
summary(mod_seedpred_phen_88)
summary(mod_seedpred_phen_89)
```

Opening date does not seem to have an effect on seed predation.

1988 and 1989 (1987 p=0.078): Basal flowers (lower relpos_fl) have a higher seed predation than distal flowers within the raceme. 

There are no significant effects of flower position among racemes.

Build the piecewise SEMs:

```{r}
path_seedpred_87<-psem(mod_seedpred_phen_87,mod_phen_87)
path_seedpred_88<-psem(mod_seedpred_phen_88,mod_phen_88)
path_seedpred_89<-psem(mod_seedpred_phen_89,mod_phen_89)
```

```{r}
summary(path_seedpred_87)
summary(path_seedpred_88)
summary(path_seedpred_89)
```

Model for 1987 is singular (checked using performance::check_singularity).
Singularity disappears when removing random effects of raceme_id and shoot_id.
Only problem is for calculating R squared values (that we so far not show in the figure), so OK so far. If we want to show models without those random effects not included, results in terms of coefficients, etc are similar. 

Plots:

```{r}
plot_path_seedpred_87<-plot(path_seedpred_87,layout="tree",
                          node_attrs=data.frame(shape="rectangle",
                                                color="black",fillcolor="white",
                                                fontsize=8,
                                                fontname="Times-Roman",
                                                fixedsize=F),
                          edge_attrs=data.frame(style="solid",color="grey",
                                                fontsize=8,
                                                fontname="Times-Roman"),
                          title="1987")
plot_path_seedpred_88<-plot(path_seedpred_88,layout="tree",
                         node_attrs=data.frame(shape="rectangle",
                                               color="black",fillcolor="white",
                                               fontsize=8,
                                               fontname="Times-Roman",
                                               fixedsize=F),
                         edge_attrs=data.frame(style="solid",color="grey",
                                               fontsize=8,
                                               fontname="Times-Roman"),
                         title="1988")
plot_path_seedpred_89<-plot(path_seedpred_89,layout="tree",
                         node_attrs=data.frame(shape="rectangle",
                                               color="black",fillcolor="white",
                                               fontsize=8,
                                               fontname="Times-Roman",
                                               fixedsize=F),
                         edge_attrs=data.frame(style="solid",color="grey",
                                               fontsize=8,
                                               fontname="Times-Roman"),
     title="1989")
```

```{r}
save_png(plot_path_seedpred_87,"output/figures/plot_path_seedpred_87.png")
save_png(plot_path_seedpred_88,"output/figures/plot_path_seedpred_88.png")
save_png(plot_path_seedpred_89,"output/figures/plot_path_seedpred_89.png")
writeLines(export_svg(plot_path_seedpred_87),
           "output/figures/plot_path_seedpred_87.svg")
writeLines(export_svg(plot_path_seedpred_88),
           "output/figures/plot_path_seedpred_88.svg")
writeLines(export_svg(plot_path_seedpred_89),
           "output/figures/plot_path_seedpred_89.svg")
```

## Figure 4: Path models (Inkscape)

# Q5: Strength of flower position effects on fruit set depends on fruit initiation and flowering duration

With fruit initiation & range

```{r}
mod_frset_87_Q5ab<-glmmTMB(fruit_set~(relpos_fl*relpos_rac)* 
                           # Interaction * in mod_frset_87 
                           (tot_fr_init_in_plant+range_opening_date)+
                         (1|id/shoot_id/raceme_id),
                         subset(data_id_flowers,year==1987),family="binomial")
mod_frset_88_Q5ab<-glmmTMB(fruit_set~(relpos_fl+relpos_rac)* 
                           # Interaction NS in mod_frset_88 
                           (tot_fr_init_in_plant+range_opening_date)+
                         (1|id/shoot_id/raceme_id),
                         subset(data_id_flowers,year==1988),family="binomial")
mod_frset_89_Q5ab<-glmmTMB(fruit_set~(relpos_fl+relpos_rac)* 
                           # Interaction NS in mod_frset_89 
                           (tot_fr_init_in_plant+range_opening_date)+
                         (1|id/shoot_id/raceme_id),
                         subset(data_id_flowers,year==1989),family="binomial")
summary(mod_frset_87_Q5ab)
summary(mod_frset_88_Q5ab)
summary(mod_frset_89_Q5ab)
```

## Table 3

```{r}
tab_model(mod_frset_87_Q5ab,mod_frset_88_Q5ab,mod_frset_89_Q5ab,
          transform=NULL,show.intercept=F,show.ci=F,show.se=T,show.stat=T,
          show.r2=T,show.icc=F,show.re.var=F,show.ngroups=F,digits=3,
          dv.labels=c("1987","1988","1989"),
          file="output/tables/Table3.doc")
```

## Figure 5

```{r}
fig5a_legend<-get_legend(
  ggplot()+
    geom_line(data=ggpredict(mod_frset_87_Q5ab,
                             terms=c("relpos_fl[all]","range_opening_date[all]",
                                     "relpos_rac[quart]")),
              aes(x=x,y=predicted,group=group,color=as.numeric(group)))+
    facet_wrap(~facet,nrow=1)+
    my_theme_legend()+xlab("Flower position")+ylab("Fruit set")+
    labs(fill="Range opening date",color="Range opening date")+
    theme(legend.position="top")+scale_color_viridis(option="D")+
    labs(tag ="Raceme position")+
    theme(plot.tag.position="top",
          plot.tag=element_text(hjust=0,size=16)))
fig5b1_legend<-get_legend(
  ggplot()+
    geom_line(data=ggpredict(mod_frset_88_Q5ab,
                             terms=c("relpos_fl[all]","tot_fr_init_in_plant[all]")),
              aes(x=x,y=predicted,group=group,color=as.numeric(group)))+
    my_theme_legend()+xlab("Flower position")+ylab("Fruit set")+
    theme(legend.position="top")+
    labs(fill="Total fruit initiation",color="Total fruit initiation")+
    scale_color_viridis(option="C"))

fig5a<-ggplot()+
  geom_line(data=ggpredict(mod_frset_87_Q5ab,
                           terms=c("relpos_fl[all]","range_opening_date[all]",
                                   "relpos_rac[quart]")),
            aes(x=x,y=predicted,group=group,color=as.numeric(group)))+
  facet_wrap(~facet,nrow=1)+
  my_theme()+xlab("Flower position")+ylab("Fruit set")+
  labs(fill="Range opening date",color="Range opening date")+
  scale_color_viridis(option="D")+
  labs(tag ="Raceme position")+ggtitle("A) 1987")+
  theme(plot.tag.position="top",
        plot.tag=element_text(hjust=0,size=16))

fig5b<-ggplot()+
  geom_line(data=ggpredict(mod_frset_88_Q5ab,
                           terms=c("relpos_fl[all]","tot_fr_init_in_plant[all]")),
            aes(x=x,y=predicted,group=group,color=as.numeric(group)))+
  my_theme()+xlab("Flower position")+ylab("Fruit set")+
  ggtitle("B) 1988")+
  labs(fill="Total fruit initiation",color="Total fruit initiation")+
  scale_color_viridis(option="C")

fig5c<-ggplot()+
  geom_line(data=ggpredict(mod_frset_88_Q5ab,
                           terms=c("relpos_fl[all]","range_opening_date[all]")),
            aes(x=x,y=predicted,group=group,color=as.numeric(group)))+
  my_theme()+xlab("Flower position")+ylab("Fruit set")+
  labs(fill="Range opening date",color="Range opening date")+ggtitle("C) 1988")+
  scale_color_viridis(option="D")

fig5d<-ggplot()+
  geom_line(data=ggpredict(mod_frset_89_Q5ab,
                           terms=c("relpos_rac[all]",
                                   "range_opening_date[all]")),
            aes(x=x,y=predicted,group=group,color=as.numeric(group)))+
  my_theme()+xlab("Raceme position")+ylab("Fruit set")+
  labs(fill="Range opening date",color="Range opening date")+
  ggtitle("D) 1989")+scale_color_viridis(option="D")

fig5<-ggpubr::ggarrange(
  ggpubr::ggarrange(fig5a_legend,fig5b1_legend,ncol=2),
  fig5a,
  ggpubr::ggarrange(fig5b,fig5c,fig5d,ncol=3),
  nrow=3,heights=c(0.1,0.45,0.45)
)
fig5
ggsave(filename="output/figures/fig5.tiff",plot=fig5,
       width=20,height=20,units="cm",dpi=300,compression="lzw")
```

## ... depends on seed predation at the plant level

```{r}
mod_frset_87_Q5c<-glmmTMB(fruit_set~(relpos_fl*relpos_rac)* 
                           # Interaction * in mod_frset_87 
                           seed_predation_plant+
                         (1|id/shoot_id/raceme_id),
                         subset(data_id_flowers,year==1987),family="binomial")
mod_frset_88_Q5c<-glmmTMB(fruit_set~(relpos_fl+relpos_rac)* 
                           # Interaction NS in mod_frset_88 
                           seed_predation_plant+
                         (1|id/shoot_id/raceme_id),
                         subset(data_id_flowers,year==1988),family="binomial")
mod_frset_89_Q5c<-glmmTMB(fruit_set~(relpos_fl+relpos_rac)* 
                           # Interaction NS in mod_frset_89 
                           seed_predation_plant+
                         (1|id/shoot_id/raceme_id),
                         subset(data_id_flowers,year==1989),family="binomial")
summary(mod_frset_87_Q5c)
summary(mod_frset_88_Q5c)
summary(mod_frset_89_Q5c)
Anova(mod_frset_87_Q5c)
Anova(mod_frset_88_Q5c)
Anova(mod_frset_89_Q5c)
```

Interactions NS.

```{r}
mod_frset_87_Q5abc<-glmmTMB(fruit_set~(relpos_fl*relpos_rac)* 
                           # Interaction * in mod_frset_87 
                           (tot_fr_init_in_plant+range_opening_date+
                              seed_predation_plant)+
                         (1|id/shoot_id/raceme_id),
                         subset(data_id_flowers,year==1987),family="binomial")
mod_frset_88_Q5abc<-glmmTMB(fruit_set~(relpos_fl+relpos_rac)* 
                           # Interaction NS in mod_frset_88 
                           (tot_fr_init_in_plant+range_opening_date+
                              seed_predation_plant)+
                         (1|id/shoot_id/raceme_id),
                         subset(data_id_flowers,year==1988),family="binomial")
mod_frset_89_Q5abc<-glmmTMB(fruit_set~(relpos_fl+relpos_rac)* 
                           # Interaction NS in mod_frset_89 
                           (tot_fr_init_in_plant+range_opening_date+
                              seed_predation_plant)+
                         (1|id/shoot_id/raceme_id),
                         subset(data_id_flowers,year==1989),family="binomial")
summary(mod_frset_87_Q5abc)
summary(mod_frset_88_Q5abc)
summary(mod_frset_89_Q5abc)
Anova(mod_frset_87_Q5abc)
Anova(mod_frset_88_Q5abc)
Anova(mod_frset_89_Q5abc)
```

# Session info

```{r}
sessionInfo()
```

